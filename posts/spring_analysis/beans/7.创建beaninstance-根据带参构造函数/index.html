<!doctype html>
<html lang="en-us">
  <head>
    <title>7.创建BeanInstance-根据带参构造函数 // gngpp</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.99.1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="gngpp" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://blog.innas.cn/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="7.创建BeanInstance-根据带参构造函数"/>
<meta name="twitter:description" content="前言 在上一节讨论到 ``autowireConstructor 利用其实例化Bean，这个功能是通过调用代参构造函数来拿到Instance` 的。不多bb，开搞
protected BeanWrapper autowireConstructor( 	String beanName, RootBeanDefinition mbd, @Nullable Constructor&lt;?&gt;[] ctors, @Nullable Object[] explicitArgs) {  	return new ConstructorResolver(this).autowireConstructor(beanName, mbd, ctors, explicitArgs); 	} 上面 ConstructorResolver 这个是 构造函数解析器，是beans 中比较重要的一部分，后面也常常涉及到这个类，那么继续
这个函数长度是 200 所以一点点分析，这样比较清晰
public BeanWrapper autowireConstructor(String beanName, RootBeanDefinition mbd, 	@Nullable Constructor&lt;?&gt;[] chosenCtors, @Nullable Object[] explicitArgs) {  	/**------------------------------------------------------------------------------------------------------------ * [DESC] 解析构造函数进行数据装配然后实例化对象 * [1] 第一种情况就是只有一个构造函数并且构造函数没有参数，这和工厂方法有点像，那就直接调用无参构造函数 * [2] 第二种情况，就是多个构造函数和带参数 * 先判断是不是在构造函数上用了 {@link ConstructorProperties} 注解来标明构造函数的名称，若没有提供注解则直接从构造函数中获取参数名称 * 然后用 {@link #createArgumentArray} 去匹配和创建构造函数的参数数组，TODO 这个方法比较核心，提供许多策略去匹配参数 * [3] 最后根据构造函数的数组 直接调用构造函数 实例化对象 *------------------------------------------------------------------------------------------------------------*/ 	BeanWrapperImpl bw = new BeanWrapperImpl(); 	this."/>

    <meta property="og:title" content="7.创建BeanInstance-根据带参构造函数" />
<meta property="og:description" content="前言 在上一节讨论到 ``autowireConstructor 利用其实例化Bean，这个功能是通过调用代参构造函数来拿到Instance` 的。不多bb，开搞
protected BeanWrapper autowireConstructor( 	String beanName, RootBeanDefinition mbd, @Nullable Constructor&lt;?&gt;[] ctors, @Nullable Object[] explicitArgs) {  	return new ConstructorResolver(this).autowireConstructor(beanName, mbd, ctors, explicitArgs); 	} 上面 ConstructorResolver 这个是 构造函数解析器，是beans 中比较重要的一部分，后面也常常涉及到这个类，那么继续
这个函数长度是 200 所以一点点分析，这样比较清晰
public BeanWrapper autowireConstructor(String beanName, RootBeanDefinition mbd, 	@Nullable Constructor&lt;?&gt;[] chosenCtors, @Nullable Object[] explicitArgs) {  	/**------------------------------------------------------------------------------------------------------------ * [DESC] 解析构造函数进行数据装配然后实例化对象 * [1] 第一种情况就是只有一个构造函数并且构造函数没有参数，这和工厂方法有点像，那就直接调用无参构造函数 * [2] 第二种情况，就是多个构造函数和带参数 * 先判断是不是在构造函数上用了 {@link ConstructorProperties} 注解来标明构造函数的名称，若没有提供注解则直接从构造函数中获取参数名称 * 然后用 {@link #createArgumentArray} 去匹配和创建构造函数的参数数组，TODO 这个方法比较核心，提供许多策略去匹配参数 * [3] 最后根据构造函数的数组 直接调用构造函数 实例化对象 *------------------------------------------------------------------------------------------------------------*/ 	BeanWrapperImpl bw = new BeanWrapperImpl(); 	this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.innas.cn/posts/spring_analysis/beans/7.%E5%88%9B%E5%BB%BAbeaninstance-%E6%A0%B9%E6%8D%AE%E5%B8%A6%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-02T11:39:34+00:00" />
<meta property="article:modified_time" content="2021-08-02T11:39:34+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://blog.innas.cn/"><img class="app-header-avatar" src="/avatar.png" alt="gngpp" /></a>
      <h1>gngpp</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="/categories/">Categories</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p>好记性不如烂笔头，这些笔记只为在我暂时忘记时，帮自己度过难关。我很高兴如果它们也能帮助到你。</p>
      <div class="app-header-social">
        
          <a href="https://github.com/gngpp" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">7.创建BeanInstance-根据带参构造函数</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Aug 2, 2021
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          7 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://blog.innas.cn/tags/spring-bean/">Spring-Bean</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <h3 id="前言">前言</h3>
<p>在上一节讨论到 ``autowireConstructor<code> 利用其实例化</code>Bean<code>，这个功能是通过调用</code>代参构造函数<code>来拿到</code>Instance` 的。不多bb，开搞</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> BeanWrapper <span style="color:#a6e22e">autowireConstructor</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> Constructor<span style="color:#f92672">&lt;?&gt;[]</span> ctors<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">[]</span> explicitArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ConstructorResolver<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">).</span><span style="color:#a6e22e">autowireConstructor</span><span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> ctors<span style="color:#f92672">,</span> explicitArgs<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>上面 <code>ConstructorResolver</code> 这个是 构造函数解析器，是<code>beans</code> 中比较重要的一部分，后面也常常涉及到这个类，那么继续</p>
<p>这个函数长度是 <code>200</code> 所以一点点分析，这样比较清晰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> BeanWrapper <span style="color:#a6e22e">autowireConstructor</span><span style="color:#f92672">(</span>String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">@Nullable</span> Constructor<span style="color:#f92672">&lt;?&gt;[]</span> chosenCtors<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> Object<span style="color:#f92672">[]</span> explicitArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/**------------------------------------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [DESC] 解析构造函数进行数据装配然后实例化对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [1] 第一种情况就是只有一个构造函数并且构造函数没有参数，这和工厂方法有点像，那就直接调用无参构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [2] 第二种情况，就是多个构造函数和带参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * 先判断是不是在构造函数上用了 {@link ConstructorProperties} 注解来标明构造函数的名称，若没有提供注解则直接从构造函数中获取参数名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * 然后用 {@link #createArgumentArray} 去匹配和创建构造函数的参数数组，TODO 这个方法比较核心，提供许多策略去匹配参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [3] 最后根据构造函数的数组 直接调用构造函数 实例化对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 *------------------------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span>		BeanWrapperImpl bw <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanWrapperImpl<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initBeanWrapper</span><span style="color:#f92672">(</span>bw<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Constructor<span style="color:#f92672">&lt;?&gt;</span> constructorToUse <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		ArgumentsHolder argsHolderToUse <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		Object<span style="color:#f92672">[]</span> argsToUse <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// [1] 尝试中缓存中获取，如果前面已经解析了的话
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>explicitArgs <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			argsToUse <span style="color:#f92672">=</span> explicitArgs<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			Object<span style="color:#f92672">[]</span> argsToResolve <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">constructorArgumentLock</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				constructorToUse <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Constructor<span style="color:#f92672">&lt;?&gt;)</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">resolvedConstructorOrFactoryMethod</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>constructorToUse <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">constructorArgumentsResolved</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Found a cached constructor...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					argsToUse <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">resolvedConstructorArguments</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>argsToUse <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						argsToResolve <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">preparedConstructorArguments</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>argsToResolve <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 能从缓存拿到就预先解析参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				argsToUse <span style="color:#f92672">=</span> resolvePreparedArguments<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> bw<span style="color:#f92672">,</span> constructorToUse<span style="color:#f92672">,</span> argsToResolve<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>优先还是从缓存中拿到，调用构造函数所需要的参数，如果说没有提供则就自己解析，在上面 <code>explicitArgs</code> 是我们调用 <code>getBean</code> 的时候可以传入进来的参数</p>
<p>解析参数用的是 <code>resolvePreparedArguments</code>的方法，后面会单独讨论，我们先跟踪大体框架</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// [2] 若从缓存拿不到，则自己解析Class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>constructorToUse <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> argsToUse <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Take specified constructors, if any.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			Constructor<span style="color:#f92672">&lt;?&gt;[]</span> candidates <span style="color:#f92672">=</span> chosenCtors<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidates <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 直接获取构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				Class<span style="color:#f92672">&lt;?&gt;</span> beanClass <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getBeanClass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					candidates <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isNonPublicAccessAllowed</span><span style="color:#f92672">()</span> <span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>							beanClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredConstructors</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> beanClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getConstructors</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Throwable ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BeanCreationException<span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResourceDescription</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>							<span style="color:#e6db74">&#34;Resolution of declared constructors on bean Class [&#34;</span> <span style="color:#f92672">+</span> beanClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>							<span style="color:#e6db74">&#34;] from ClassLoader [&#34;</span> <span style="color:#f92672">+</span> beanClass<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;] failed&#34;</span><span style="color:#f92672">,</span> ex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Note 这里和工厂方法那边有点像，一个构造函数并且没有参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>candidates<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 1 <span style="color:#f92672">&amp;&amp;</span> explicitArgs <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">hasConstructorArgumentValues</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				Constructor<span style="color:#f92672">&lt;?&gt;</span> uniqueCandidate <span style="color:#f92672">=</span> candidates<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>uniqueCandidate<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">constructorArgumentLock</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">resolvedConstructorOrFactoryMethod</span> <span style="color:#f92672">=</span> uniqueCandidate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>						mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">constructorArgumentsResolved</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>						mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">resolvedConstructorArguments</span> <span style="color:#f92672">=</span> EMPTY_ARGS<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Note 只有一个默认构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					bw<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanInstance</span><span style="color:#f92672">(</span>instantiate<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> uniqueCandidate<span style="color:#f92672">,</span> EMPTY_ARGS<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> bw<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>如果从缓存上拿不到，则需要自己解析<code>class</code>，先获取所有的构造函数，如果构造函数只有一个，并且是无参构造函数，那就直接调用 <code>instantiate</code>拿到 <code>Instance</code> ，这很容易理解，只有一个构造函数并且是无参的，那就很简单了。</p>
<p><strong>值得关注的是 instantiate</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Object <span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">,</span> Constructor<span style="color:#f92672">&lt;?&gt;</span> constructorToUse<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> argsToUse<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			InstantiationStrategy strategy <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getInstantiationStrategy</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getSecurityManager</span><span style="color:#f92672">()</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> AccessController<span style="color:#f92672">.</span><span style="color:#a6e22e">doPrivileged</span><span style="color:#f92672">((</span>PrivilegedAction<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;)</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>						strategy<span style="color:#f92672">.</span><span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">,</span> constructorToUse<span style="color:#f92672">,</span> argsToUse<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getAccessControlContext</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> strategy<span style="color:#f92672">.</span><span style="color:#a6e22e">instantiate</span><span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">,</span> constructorToUse<span style="color:#f92672">,</span> argsToUse<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>上面有一个值得关注的点 <code>InstantiationStrategy</code> ，<code>spring</code> 提供了一个默认的初始化策略</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AbstractAutowireCapableBeanFactory</span> <span style="color:#66d9ef">extends</span> AbstractBeanFactory
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">implements</span> AutowireCapableBeanFactory <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/** Strategy for creating bean instances. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Note CGI 代理策略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">private</span> InstantiationStrategy instantiationStrategy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CglibSubclassingInstantiationStrategy<span style="color:#f92672">();</span>
</span></span></code></pre></div><p>也就是 <code>CGI动态代理</code>，有兴趣可以深入，在这不做讨论</p>
<p>继续上面的第三步</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// [3] 构造函数可能有多个，并且参数有多个,那就得解析了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">boolean</span> autowiring <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>chosenCtors <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>					mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResolvedAutowireMode</span><span style="color:#f92672">()</span> <span style="color:#f92672">==</span> AutowireCapableBeanFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">AUTOWIRE_CONSTRUCTOR</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			ConstructorArgumentValues resolvedValues <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> minNrOfArgs<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>explicitArgs <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				minNrOfArgs <span style="color:#f92672">=</span> explicitArgs<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// [4] 利用类型转换器，转换一下提供的参数，也就是 constructor-arg提供的参数 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				ConstructorArgumentValues cargs <span style="color:#f92672">=</span> mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getConstructorArgumentValues</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				resolvedValues <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConstructorArgumentValues<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				minNrOfArgs <span style="color:#f92672">=</span> resolveConstructorArguments<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> bw<span style="color:#f92672">,</span> cargs<span style="color:#f92672">,</span> resolvedValues<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>如果构造函数有多个并且参数有多个，那就会执行到这里，这个时候就得匹配合适的构造函数，匹配合适的构造函数之前先转换一下，为什么需要转换？</p>
<p>需要转换的数值是我们定义 <code>constructor-arg</code> 中指定的, 至于为什么转换，有待研究, 暂时不管</p>
<p>继续看第五步：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// [5] 下面开始寻找合适的构造函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			AutowireUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">sortConstructors</span><span style="color:#f92672">(</span>candidates<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> minTypeDiffWeight <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			Set<span style="color:#f92672">&lt;</span>Constructor<span style="color:#f92672">&lt;?&gt;&gt;</span> ambiguousConstructors <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			LinkedList<span style="color:#f92672">&lt;</span>UnsatisfiedDependencyException<span style="color:#f92672">&gt;</span> causes <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Constructor<span style="color:#f92672">&lt;?&gt;</span> candidate <span style="color:#f92672">:</span> candidates<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				Class<span style="color:#f92672">&lt;?&gt;[]</span> paramTypes <span style="color:#f92672">=</span> candidate<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterTypes</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>constructorToUse <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> argsToUse <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> argsToUse<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Already found greedy constructor that can be satisfied -&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// do not look any further, there are only less greedy constructors left.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 如果构造函数的参数 &lt; 提供的参数个数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// TODO so why?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> minNrOfArgs<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// [6] 检查参数是否匹配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				ArgumentsHolder argsHolder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolvedValues <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// Note 判断是不是在构造函数上用了注解 ConstructorProperties 来标示构造函数的参数名字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						String<span style="color:#f92672">[]</span> paramNames <span style="color:#f92672">=</span> ConstructorPropertiesChecker<span style="color:#f92672">.</span><span style="color:#a6e22e">evaluate</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">,</span> paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>paramNames <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>							ParameterNameDiscoverer pnd <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterNameDiscoverer</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e">// Note 如果没有提供注解，那就直接从构造函数中获取参数名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>							<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>pnd <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>								paramNames <span style="color:#f92672">=</span> pnd<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterNames</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>							<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// TODO 这个方法已经解析完毕，可以跟进
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						<span style="color:#75715e">// Note 负责使用多种策略去匹配参数，然后创建参数holder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						<span style="color:#75715e">// paramTypes 构造函数参数类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						<span style="color:#75715e">// paramNames 构造函数参数名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						<span style="color:#75715e">// resolvedValues 在bean的定义中提供的数值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						argsHolder <span style="color:#f92672">=</span> createArgumentArray<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> resolvedValues<span style="color:#f92672">,</span> bw<span style="color:#f92672">,</span> paramTypes<span style="color:#f92672">,</span> paramNames<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>								getUserDeclaredConstructor<span style="color:#f92672">(</span>candidate<span style="color:#f92672">),</span> autowiring<span style="color:#f92672">,</span> candidates<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 1<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnsatisfiedDependencyException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// Swallow and try next constructor.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>						<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>causes <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>							causes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>						causes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>ex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Note 用户没有提供参数, 那就看下有没有提供显示的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#75715e">// Note 就是调用 #getBean的时候 用户是否传入了参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Explicit arguments given -&gt; arguments length must match exactly.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> explicitArgs<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					argsHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArgumentsHolder<span style="color:#f92672">(</span>explicitArgs<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">int</span> typeDiffWeight <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isLenientConstructorResolution</span><span style="color:#f92672">()</span> <span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>						argsHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getTypeDifferenceWeight</span><span style="color:#f92672">(</span>paramTypes<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> argsHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getAssignabilityWeight</span><span style="color:#f92672">(</span>paramTypes<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Choose this constructor if it represents the closest match.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>typeDiffWeight <span style="color:#f92672">&lt;</span> minTypeDiffWeight<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					constructorToUse <span style="color:#f92672">=</span> candidate<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					argsHolderToUse <span style="color:#f92672">=</span> argsHolder<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					argsToUse <span style="color:#f92672">=</span> argsHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">arguments</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					minTypeDiffWeight <span style="color:#f92672">=</span> typeDiffWeight<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					ambiguousConstructors <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>constructorToUse <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> typeDiffWeight <span style="color:#f92672">==</span> minTypeDiffWeight<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ambiguousConstructors <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						ambiguousConstructors <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>						ambiguousConstructors<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>constructorToUse<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					ambiguousConstructors<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>candidate<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>constructorToUse <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>causes <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					UnsatisfiedDependencyException ex <span style="color:#f92672">=</span> causes<span style="color:#f92672">.</span><span style="color:#a6e22e">removeLast</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Exception cause <span style="color:#f92672">:</span> causes<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">onSuppressedException</span><span style="color:#f92672">(</span>cause<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">throw</span> ex<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ambiguousConstructors <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">isLenientConstructorResolution</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>explicitArgs <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> argsHolderToUse <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				argsHolderToUse<span style="color:#f92672">.</span><span style="color:#a6e22e">storeCache</span><span style="color:#f92672">(</span>mbd<span style="color:#f92672">,</span> constructorToUse<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">state</span><span style="color:#f92672">(</span>argsToUse <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unresolved constructor arguments&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// [8] 调用构造函数 + 参数 进行实例化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		bw<span style="color:#f92672">.</span><span style="color:#a6e22e">setBeanInstance</span><span style="color:#f92672">(</span>instantiate<span style="color:#f92672">(</span>beanName<span style="color:#f92672">,</span> mbd<span style="color:#f92672">,</span> constructorToUse<span style="color:#f92672">,</span> argsToUse<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> bw<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>匹配构造函数，按功能名称来看，其主要责任是根据提供的参数找到合适的构造函数，以我们对<code>spring</code>的认知，无非有几种情况：</p>
<ul>
<li>在 bean 的定义中使用 <code>constructor-arg</code> 标签提供参数的名称和值</li>
<li>在调用 <code>getBean</code> 处提供显式的参数</li>
<li>不提供参数则根据类型进行装配，类型必须得是 bean，否则 <code>factory</code> 根本无法知道要装配什么，其只能装配bean。</li>
</ul>
<p>那就可以先看第五步：</p>
<blockquote>
<p>​	第五步很简单，也就是将构造函数按照某种策略进行排序。在这不详尽，后期才会详尽各种工具类</p>
</blockquote>
<p>第六步：</p>
<blockquote>
<p>就要获取参数的类型和名称，如果使用了 <code>constructor-arg</code> 则就直接拿这个标签定义的类型和名称</p>
<p>否则，解析构造函数拿到参数类型，如果在构造函数上方使用了 <code> @ConstructorProperties</code> 注解，那就直接从这个注解中拿到参数的名称</p>
<p>最后调用 <code>createArgumentArray</code> 创建参数数组了，所谓的参数数组就是用来调用构造函数所需要的参数，因为我们要调用其构造函数所以我们就必须得获取参数数组。</p>
<p><code>createArgumentArray</code> 里面提供了三种参数匹配的策略：</p>
<ol>
<li>如果是使用 <code>constructor-arg</code> ，那就生成参数数组，因为 <code>constructor-arg</code> 一个属性就是 <code>index </code>就是用来表示参数的索引，另外一个就是 <code>value</code> 用来代表参数的值，只需要索引和值就能生成参数数组。</li>
<li>根据构造函数的参数类型和名称进行匹配，如果我们使用 <code>constructor-arg</code>中没有指定 <code>index</code> ，但我们指定了 <code>name</code> 和 <code>type </code> 和 <code>value</code> 那么我们也可以用这些进行匹配。</li>
<li>第三种就是 参数类型是 bean类型，而且我们也没有以任何方式提供参数，这个时候就要用到自动装配了，自动装配的实现方式到最后详解.</li>
</ol>
</blockquote>
<p>第八步：</p>
<blockquote>
<p>​	利用匹配到的构造函数和参数值调用构造函数就可以拿到<code>Instance</code>了</p>
</blockquote>
<p>参数匹配实现代码在这里列出，到时候会单独挑出来：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> ArgumentsHolder <span style="color:#a6e22e">createArgumentArray</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>			String beanName<span style="color:#f92672">,</span> RootBeanDefinition mbd<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> ConstructorArgumentValues resolvedValues<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			BeanWrapper bw<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;[]</span> paramTypes<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Nullable</span> String<span style="color:#f92672">[]</span> paramNames<span style="color:#f92672">,</span> Executable executable<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">boolean</span> autowiring<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> fallback<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> UnsatisfiedDependencyException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/**-----------------------------------------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [DESC] 匹配参数并且创建参数持有者
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * paramTypes 构造函数参数类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * paramNames 构造函数参数名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * resolvedValues 在bean的定义中提供的参数数值信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [1] 采用两种方式去匹配参数，第一种是按照索引 index=&#34;1&#34; 指定的索引去匹配 {@link ConstructorArgumentValues#getArgumentValue}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * 第二种是普通匹配，就是参数类型和名称匹配就ok
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * 第三种是不指定参数类型和名称， 只要是参数类型能互相转换就匹配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * [2] 上面两种方式都无法匹配成功，那就判断是否开启了自动装配，因为参数类型可能是Bean {@link #resolveAutowiredArgument}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 *-----------------------------------------------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		TypeConverter customConverter <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getCustomTypeConverter</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>		TypeConverter converter <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>customConverter <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> customConverter <span style="color:#f92672">:</span> bw<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		ArgumentsHolder args <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArgumentsHolder<span style="color:#f92672">(</span>paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		Set<span style="color:#f92672">&lt;</span>ConstructorArgumentValues<span style="color:#f92672">.</span><span style="color:#a6e22e">ValueHolder</span><span style="color:#f92672">&gt;</span> usedValueHolders <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashSet<span style="color:#f92672">&lt;&gt;(</span>paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>		Set<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> autowiredBeanNames <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedHashSet<span style="color:#f92672">&lt;&gt;(</span>4<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// [1] 遍历所有的参数类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> paramIndex <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> paramIndex <span style="color:#f92672">&lt;</span> paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> paramIndex<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 参数类型和名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			Class<span style="color:#f92672">&lt;?&gt;</span> paramType <span style="color:#f92672">=</span> paramTypes<span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>			String paramName <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>paramNames <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> paramNames<span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Note 根据索引或者普通方式去匹配构造参数值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// Note 我们可以在bean定义中用 index=&#34;1&#34; 来指定参数的索引
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// Try to find matching constructor argument value, either indexed or generic.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			ConstructorArgumentValues<span style="color:#f92672">.</span><span style="color:#a6e22e">ValueHolder</span> valueHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolvedValues <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 这里面采用两种方式，将构造函数所需参数和提供的参数进行匹配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// [1] 采用index索引方式，前提得在定义bean 的时候用 index=&#34;1&#34;  指定参数, 然后提供的参数和所需的参数名和类型进行对比，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// 若一致则匹配成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// [2] 采用通用方式，就是根据所需要的paramType和paramName去 遍历提供的所有参数信息，若参数名和参数类型一样，则匹配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// 成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				valueHolder <span style="color:#f92672">=</span> resolvedValues<span style="color:#f92672">.</span><span style="color:#a6e22e">getArgumentValue</span><span style="color:#f92672">(</span>paramIndex<span style="color:#f92672">,</span> paramType<span style="color:#f92672">,</span> paramName<span style="color:#f92672">,</span> usedValueHolders<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// If we couldn&#39;t find a direct match and are not supposed to autowire,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// let&#39;s try the next generic, untyped argument value as fallback:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// it could match after type conversion (for example, String -&gt; int).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 如果参数类型和参数名称都没有匹配到
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// Note 则将参数类型和参数名称设置为 null进行匹配，因为 string可以转换为int
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// Note 因为没有适合的参数类型，所以我们匹配这种 可以转换的类型的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>valueHolder <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(!</span>autowiring <span style="color:#f92672">||</span> paramTypes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> resolvedValues<span style="color:#f92672">.</span><span style="color:#a6e22e">getArgumentCount</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					valueHolder <span style="color:#f92672">=</span> resolvedValues<span style="color:#f92672">.</span><span style="color:#a6e22e">getGenericArgumentValue</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> usedValueHolders<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>valueHolder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// We found a potential match - let&#39;s give it a try.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// Do not consider the same value definition multiple times!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				usedValueHolders<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>valueHolder<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				Object originalValue <span style="color:#f92672">=</span> valueHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>				Object convertedValue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 下面进行参数转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>valueHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">isConverted</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 已经转换过了，则直接拿它的值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					convertedValue <span style="color:#f92672">=</span> valueHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getConvertedValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>					args<span style="color:#f92672">.</span><span style="color:#a6e22e">preparedArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> convertedValue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Note 否则就是没有转换过的参数, 下面调用转换器进行参数类型转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>					MethodParameter methodParam <span style="color:#f92672">=</span> MethodParameter<span style="color:#f92672">.</span><span style="color:#a6e22e">forExecutable</span><span style="color:#f92672">(</span>executable<span style="color:#f92672">,</span> paramIndex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						convertedValue <span style="color:#f92672">=</span> converter<span style="color:#f92672">.</span><span style="color:#a6e22e">convertIfNecessary</span><span style="color:#f92672">(</span>originalValue<span style="color:#f92672">,</span> paramType<span style="color:#f92672">,</span> methodParam<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>TypeMismatchException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsatisfiedDependencyException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>								mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResourceDescription</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> InjectionPoint<span style="color:#f92672">(</span>methodParam<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>								<span style="color:#e6db74">&#34;Could not convert argument value of type [&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>										ObjectUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">nullSafeClassName</span><span style="color:#f92672">(</span>valueHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">())</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>										<span style="color:#e6db74">&#34;] to required type [&#34;</span> <span style="color:#f92672">+</span> paramType<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]: &#34;</span> <span style="color:#f92672">+</span> ex<span style="color:#f92672">.</span><span style="color:#a6e22e">getMessage</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>					Object sourceHolder <span style="color:#f92672">=</span> valueHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getSource</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sourceHolder <span style="color:#66d9ef">instanceof</span> ConstructorArgumentValues<span style="color:#f92672">.</span><span style="color:#a6e22e">ValueHolder</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>						Object sourceValue <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ConstructorArgumentValues<span style="color:#f92672">.</span><span style="color:#a6e22e">ValueHolder</span><span style="color:#f92672">)</span> sourceHolder<span style="color:#f92672">).</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>						args<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveNecessary</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>						args<span style="color:#f92672">.</span><span style="color:#a6e22e">preparedArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> sourceValue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 存放转换后的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				args<span style="color:#f92672">.</span><span style="color:#a6e22e">arguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> convertedValue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				args<span style="color:#f92672">.</span><span style="color:#a6e22e">rawArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> originalValue<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 没有匹配的合适的参数, 上面两种方式都没有匹配到，那么 还有什么策略 ？ TODO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// TODO of course 上面支持的是基本类型的匹配
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>				MethodParameter methodParam <span style="color:#f92672">=</span> MethodParameter<span style="color:#f92672">.</span><span style="color:#a6e22e">forExecutable</span><span style="color:#f92672">(</span>executable<span style="color:#f92672">,</span> paramIndex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// DESC 判断是否支持自动装配，意思就是参数类型可能是一个bean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>autowiring<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsatisfiedDependencyException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>							mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResourceDescription</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> InjectionPoint<span style="color:#f92672">(</span>methodParam<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>							<span style="color:#e6db74">&#34;Ambiguous argument values for parameter of type [&#34;</span> <span style="color:#f92672">+</span> paramType<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>							<span style="color:#e6db74">&#34;] - did you specify the correct bean references as arguments?&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Note 尝试装配Bean到参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					Object autowiredArgument <span style="color:#f92672">=</span> resolveAutowiredArgument<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>							methodParam<span style="color:#f92672">,</span> beanName<span style="color:#f92672">,</span> autowiredBeanNames<span style="color:#f92672">,</span> converter<span style="color:#f92672">,</span> fallback<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>					args<span style="color:#f92672">.</span><span style="color:#a6e22e">rawArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> autowiredArgument<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					args<span style="color:#f92672">.</span><span style="color:#a6e22e">arguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> autowiredArgument<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					args<span style="color:#f92672">.</span><span style="color:#a6e22e">preparedArguments</span><span style="color:#f92672">[</span>paramIndex<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> autowiredArgumentMarker<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>					args<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveNecessary</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>BeansException ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnsatisfiedDependencyException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>							mbd<span style="color:#f92672">.</span><span style="color:#a6e22e">getResourceDescription</span><span style="color:#f92672">(),</span> beanName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> InjectionPoint<span style="color:#f92672">(</span>methodParam<span style="color:#f92672">),</span> ex<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String autowiredBeanName <span style="color:#f92672">:</span> autowiredBeanNames<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">beanFactory</span><span style="color:#f92672">.</span><span style="color:#a6e22e">registerDependentBean</span><span style="color:#f92672">(</span>autowiredBeanName<span style="color:#f92672">,</span> beanName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">isDebugEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>				logger<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Autowiring by type from bean name &#39;&#34;</span> <span style="color:#f92672">+</span> beanName <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34;&#39; via &#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>executable <span style="color:#66d9ef">instanceof</span> Constructor <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;constructor&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;factory method&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>						<span style="color:#e6db74">&#34; to bean named &#39;&#34;</span> <span style="color:#f92672">+</span> autowiredBeanName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> args<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span></code></pre></div><hr>
<p>那就在最后总结一下根据有参构造函数创建 <code>Instance</code></p>
<ul>
<li>
<p>首先先判断构造函数是不是只有一个，并且构造函数无参数，若是则直接 <code>new</code></p>
</li>
<li>
<p>存在多参数和多构造函数</p>
<blockquote>
<pre><code>1.	获取构造函数参数的 `type` 和 `name`，可以从 `constructor-arg` 提供的属性获取, 参数名也可以通过@ConstructorProperties 注解获取
2.	获取提供的参数值，可以从 `constructor-arg` 提供的属性获取，也可以通过 `getBean`提供的显式参数获取
</code></pre>
<p>匹配策略：</p>
<ol>
<li><code>constructor-arg</code>提供了 <code>index</code> 和 <code>value</code>，则利用 这两个属性就能匹配</li>
<li><code>consurtctor-arg</code>提供了 <code>name</code> 和 <code>value</code>，根据这两个属性进行匹配</li>
<li>只提供了 <code>value</code>，类型转换如果类型转换后能匹配当前构造函数</li>
<li>什么都没提供，自动装配</li>
</ol>
</blockquote>
</li>
</ul>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
